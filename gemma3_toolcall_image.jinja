{#- Begin-of-sequence token to start the model prompt -#}
{{ bos_token }}
{#- å¤„ç† system messageï¼ˆGemma ä¸æ”¯æŒï¼Œéœ€è¦å¡åˆ°ç¬¬ä¸€è½® user å‰é¢ï¼‰ -#}
{%- if messages[0]['role'] == 'system' -%}
    {%- if messages[0]['content'] is string -%}
        {%- set first_user_prefix = messages[0]['content'] + '\n\n' -%}
    {%- else -%}
        {%- set first_user_prefix = messages[0]['content'][0]['text'] + '\n\n' -%}
    {%- endif -%}
    {%- set loop_messages = messages[1:] -%}
{%- else -%}
    {%- set first_user_prefix = "" -%}
    {%- set loop_messages = messages -%}
{%- endif -%}

{#- tools æœªå®šä¹‰æ—¶è®¾ä¸º none -#}
{%- if not tools is defined %}
    {%- set tools = none %}
{%- endif %}

{#- æ ¡éªŒ user/assistant è½®æµå‡ºç° -#}
{%- for message in loop_messages | rejectattr("role", "equalto", "tool") | selectattr("tool_calls", "undefined") %}
    {%- if (message['role'] == 'user') != (loop.index0 % 2 == 0) %}
        {{ raise_exception("Conversation roles must alternate user/assistant/user/assistant/...") }}
    {%- endif %}
{%- endfor %}

{#- ä¸»æ¶ˆæ¯å¾ªç¯ -#}
{%- for message in loop_messages %}
    {%- if message['role'] == 'assistant' %}
        {%- set role = "model" %}
    {%- elif message['role'] == 'tool' %}
        {%- set role = "user" %}
    {%- else %}
        {%- set role = message['role'] %}
    {%- endif %}

    {{ '<start_of_turn>' + role + '\n' }}

    {%- if loop.first %}
        {{ first_user_prefix }}
        {%- if tools is not none %}
            {{- "ä»¥ä¸‹æ˜¯ä½ å¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼ˆå·¥å…·ï¼‰åˆ—è¡¨ã€‚" -}}
            {{- "ğŸ’¡ å¦‚æœä½ å†³å®šè°ƒç”¨å‡½æ•°ï¼Œè¯·åªè¿”å› Python æ ¼å¼çš„å‡½æ•°è°ƒç”¨åˆ—è¡¨ã€‚" -}}
            {{- "âŒ ä¸è¦è§£é‡Šå‡½æ•°å«ä¹‰" -}}
            {{- "âŒ ä¸è¦ä½¿ç”¨ä»£ç å—" -}}
            {{- "âŒ ä¸è¦ä½¿ç”¨ Markdown æˆ–å˜é‡" -}}
            {{- "âŒ ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜æ–‡å­—" -}}
            {{- "âœ… æ­£ç¡®çš„è°ƒç”¨æ ¼å¼ç¤ºä¾‹ï¼š" -}}
            {{- "[å‡½æ•°å1(å‚æ•°1=\"å€¼\", å‚æ•°2=2), å‡½æ•°å2(...) ]" -}}
            {{- "âš ï¸ å¦‚æœæ²¡æœ‰åˆé€‚çš„å‡½æ•°ï¼Œæˆ–è€…å‚æ•°ä¸å®Œæ•´ï¼Œè¯·ç›´æ¥è¯´æ˜ï¼Œä¸è¦ç¼–é€ å‚æ•°ã€‚" -}}
            {{- "ä»¥ä¸‹æ˜¯ä½ å¯ä»¥ä½¿ç”¨çš„å‡½æ•°å®šä¹‰ï¼š" -}}
            {{- tools | tojson(indent=4) -}}
            {{- "\n\n" -}}
        {%- endif %}
    {%- endif %}

    {#- æ¸²æŸ“å·¥å…·è°ƒç”¨ï¼ˆæ ‡å‡† JSON æ ¼å¼ï¼‰ -#}
    {%- if 'tool_calls' in message %}
    [
    {%- for tool_call in message.tool_calls %}
        {%- if tool_call.function is defined %}
            {%- set func = tool_call.function %}
        {%- else %}
            {%- set func = tool_call %}
        {%- endif %}
        {{ func.name }}(
            {%- if func.arguments is mapping %}
                {%- for key, val in func.arguments.items() %}
                    {{ key }}={{ val | tojson }}{% if not loop.last %}, {% endif %}
                {%- endfor %}
            {%- elif func.arguments is iterable %}
                {{ func.arguments | map('tojson') | join(', ') }}
            {%- else %}
                {{ func.arguments | tojson }}
            {%- endif %}
        )
        {%- if not loop.last %}, {% endif %}
    {%- endfor %}
    ]
    {%- endif %}


    {#- å·¥å…·å“åº”å¼€å§‹æ ‡ç­¾ -#}
    {%- if message['role'] == 'tool' %}
        {{ '<tool_response>' -}}
    {%- endif %}

    {#- æ¸²æŸ“å†…å®¹ï¼šå­—ç¬¦ä¸²æˆ– multimodalï¼ˆå« imageï¼‰ -#}
    {%- if message['content'] is string %}
        {{ message['content'] | trim }}
    {%- elif message['content'] is iterable %}
        {%- for item in message['content'] %}
            {{ item | tojson }}{% if not loop.last %}\n{% endif %}
        {%- endfor %}
    {%- else %}
        {{ raise_exception("Invalid content type") }}
    {%- endif %}


    {%- if message['role'] == 'tool' %}
        {{ '</tool_response>' -}}
    {%- endif %}

{{'<end_of_turn>'}}
{%- endfor %}

{#- æ˜¯å¦éœ€è¦ç»§ç»­ç”Ÿæˆä¸‹ä¸€è½® model å“åº” -#}
{%- if add_generation_prompt %}
    {{'<start_of_turn>model\n'}}
{%- endif %}
